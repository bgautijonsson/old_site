---
title: "Vísitala neysluverðs"
subtitle: "Vísitalan og áhrif undirtalna á heildina"
description: | 
    Verðbólga er ekki alltaf það sama og verðbólga. Stundum er stór hluti af henni hækkun á húsnæðisverði, stundum ferðir og flutningar. Það er því gott að skoða undirvísitölurnar og áhrif þeirra á heildina.
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: "2022/07/22"
format: 
    html:
        code-fold: true
        page-layout: full
        smooth-scroll: true
        link-external-newwindow: true
editor: source
title-block-banner: true
execute:
    echo: true
    warning: false
categories:
    - efnahagur
    - R
    - íslenska
image: undirtolur.png
twitter-card:
    image: undirtolur.png
    image-width: 2400
---

```{r}
#| include: false

library(cowplot)
library(tidyverse)
library(scales)
library(pxweb)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(plotly)
Sys.setlocale(locale = "is_IS.UTF-8")
```

Hér nota ég gögn um [Hlutfallslega skiptingu og áhrifaþætti vísitölu neysluverðs](https://px.hagstofa.is/pxis/pxweb/is/Efnahagur/Efnahagur__visitolur__1_vnv__2_undirvisitolur/VIS01301.px) frá Hagstofu Íslands.

```{r}
d <- pxweb_get(
    url ="https://px.hagstofa.is:443/pxis/api/v1/is/Efnahagur/visitolur/1_vnv/2_undirvisitolur/VIS01301.px", 
    query = list(
        "Mánuður" = c("*"),
        "Liður"  = c("effect", "change_M", "breakdown"),
        "Undirvísitala" = c("*")
    ),
    verbose = FALSE
) |> 
    as.data.frame() |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    separate(manudur, into = c("ar", "manudur"), sep = "M", convert = T) |> 
    mutate(manudur = str_pad(manudur, width = 2, side = "left", pad = "0"),
           date = str_c(ar, "-", manudur, "-01") |> ymd(),
           visitala_neysluverds = visitala_neysluverds / 100) |> 
    select(date, undirvisitala, lidur, value = visitala_neysluverds) |> 
    filter(str_detect(undirvisitala, "^[0-9]{2} |Vísitala neysluverðs")) |>
    arrange(date) |> 
    mutate(undirvisitala = str_replace(undirvisitala, "^[0-9]{2} ", ""),
           lidur = fct_recode(lidur,
                              "vaegi" = "Vægi, %",
                              "breyting" = "Mánaðarbreyting, %",
                              "ahrif" = "Áhrif á vísitölu, %")) |> 
    pivot_wider(names_from = lidur, values_from = value)
```

# Undirvísitölur 

Í grófum dráttum er vísitala neysluverðs vegið meðaltal af breytingu í verði hinna ýmsu afurða sem við kaupum. Því eru t.d. áhrif breytingar á húsnæðisverði reiknuð með því að margfalda verðbreytingar þess flokks við vægi hans í vísitölunni. Vægið á að endurspegla útgjöld einhvers konar meðal-Íslendings.

Færið músina yfir myndirnar til að sjá nákvæm tölugildi og hvaða litir tilheyra hvaða flokkum.

:::{.panel-tabset}

## Vísitala

```{r}
#| fig.width: 10
#| fig.asp: 0.8
#| out.width: "100%"
#| 
roll_fun <- function(x) {
    x <- log(1 + x)
    out <- x
    
    for (i in 1:11) out <- out + lag(x, n = i)
    
    exp(out) - 1
}


plot_dat <- d |> 
    arrange(date) |> 
    group_by(undirvisitala) |> 
    mutate(year_ahrif = roll_fun(ahrif),
           year_breyting = roll_fun(breyting)) |> 
    ungroup() |> 
    filter(year(date) >= 2012) |> 
    mutate(undirvisitala = fct_reorder(undirvisitala, year_ahrif, .fun = sum),
           text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "\n",
                        "Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "\n",
                        "Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "\n",
                        "<b>Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "</b>\n",
                        "<b>Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01), "</b>"))



p <- plot_dat |> 
    filter(undirvisitala != "Vísitala neysluverðs") |> 
    ggplot(aes(date, year_ahrif, text = text)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = undirvisitala, col = undirvisitala), position = "stack", width = 30) +
    geom_line(data = plot_dat |> 
                  filter(undirvisitala == "Vísitala neysluverðs") |> 
                  mutate(text = str_c("<b>", undirvisitala, "</b>\n",
                                      "Dagsetning: ", format(date, "%B, %Y"), "\n",
                                      "Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "\n",
                                      "Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "\n",
                                      "Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "\n",
                                      "<b>Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "</b>\n",
                                      "<b>Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01), "</b>\n")), 
              aes(group = "none")) +
    scale_x_date(expand = expansion(),
                 date_breaks = "year",
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(-0.02, 0, 0.04, 0.06, 0.08, 0.1)) +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Árleg breyting vísitölu og áhrif undirtalna (2012-2022)")

ggsave(plot = p, filename = "undirtolur.png",
       width = 8, height = 0.621 * 8, scale = 1)

ggplotly(
    p,
    tooltip = "text"
) |> 
    layout(hoverlabel = list(align = "left"),
           xaxis = list(
               rangeslider = list(type = "date")
           )
    )
```

## Vægi

```{r}
#| fig.width: 10
#| fig.asp: 0.8
#| out.width: "100%"
#| 
roll_fun <- function(x) {
    x <- log(1 + x)
    out <- x
    
    for (i in 1:11) out <- out + lag(x, n = i)
    
    exp(out) - 1
}


plot_dat <- d |> 
    arrange(date) |> 
    group_by(undirvisitala) |> 
    mutate(year_ahrif = roll_fun(ahrif),
           year_breyting = roll_fun(breyting)) |> 
    ungroup() |> 
    filter(year(date) >= 2012) |> 
    mutate(undirvisitala = fct_reorder(undirvisitala, year_ahrif, .fun = sum),
           text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "\n",
                        "Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "\n",
                        "<b>Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "</b>\n",
                        "Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "\n",
                        "Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01)))



p <- plot_dat |> 
    filter(undirvisitala != "Vísitala neysluverðs") |> 
    ggplot(aes(date, vaegi, text = text)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = undirvisitala, col = undirvisitala), position = "stack", width = 30) +
    scale_x_date(expand = expansion(),
                 date_breaks = "year",
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = pretty_breaks(8),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Vægi undirflokka í vísitölu neysluverðs (2012-2022)")

ggplotly(
    p,
    tooltip = "text"
) |> 
    layout(hoverlabel = list(align = "left"),
           xaxis = list(
               rangeslider = list(type = "date")
           ))
```

## Verðbreyting

```{r}
#| fig.width: 10
#| fig.asp: 1.2
#| out.width: "100%"
#| 
roll_fun <- function(x) {
    x <- log(1 + x)
    out <- x
    
    for (i in 1:11) out <- out + lag(x, n = i)
    
    exp(out) - 1
}


plot_dat <- d |> 
    arrange(date) |> 
    group_by(undirvisitala) |> 
    mutate(year_ahrif = roll_fun(ahrif),
           year_breyting = roll_fun(breyting)) |> 
    ungroup() |> 
    filter(year(date) >= 2012) |> 
    mutate(undirvisitala = fct_reorder(undirvisitala, year_ahrif, .fun = sum),
           text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "<b>Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "</b>\n",
                        "<b>Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "</b>\n",
                        "Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "\n",
                        "Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "\n",
                        "Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01)))



p <- plot_dat |> 
    filter(undirvisitala != "Vísitala neysluverðs") |> 
    ggplot(aes(date, year_breyting, text = text)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = undirvisitala, col = undirvisitala), width = 30) +
    scale_x_date(expand = expansion(),
                 date_breaks = "2 year",
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = pretty_breaks(8)) +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    facet_wrap("undirvisitala", ncol = 3) +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Árleg verðbreyting á undirflokkum vísitölu neysluverðs (2012-2022)")

ggplotly(
    p,
    tooltip = "text"
) |> 
    layout(hoverlabel = list(align = "left"),
           xaxis = list(
               rangeslider = list(type = "date")
           ))
```

:::