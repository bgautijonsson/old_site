---
title: "Vísitala neysluverðs"
subtitle: "Vísitalan og áhrif undirtalna á heildina"
description: | 
    Verðbólga er ekki alltaf það sama og verðbólga. Stundum er stór hluti af henni hækkun á húsnæðisverði, stundum ferðir og flutningar. Það er því gott að skoða undirvísitölurnar og áhrif þeirra á heildina.
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: "2022/08/30"
format: 
    html:
        code-fold: true
        page-layout: full
        smooth-scroll: true
        link-external-newwindow: true
editor: source
title-block-banner: true
execute:
    echo: true
    warning: false
categories:
    - efnahagur
    - verðlag
    - Hagstofa
    - R
    - íslenska
image: undirtolur.png
twitter-card:
    image: undirtolur.png
---

```{r}
#| include: false

library(cowplot)
library(tidyverse)
library(scales)
library(pxweb)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(plotly)
Sys.setlocale(locale = "is_IS.UTF-8")
```

Hér nota ég gögn um [Hlutfallslega skiptingu og áhrifaþætti vísitölu neysluverðs](https://px.hagstofa.is/pxis/pxweb/is/Efnahagur/Efnahagur__visitolur__1_vnv__2_undirvisitolur/VIS01301.px) frá Hagstofu Íslands.

```{r}
d <- pxweb_get(
    url ="https://px.hagstofa.is:443/pxis/api/v1/is/Efnahagur/visitolur/1_vnv/2_undirvisitolur/VIS01301.px", 
    query = list(
        "Mánuður" = c("*"),
        "Liður"  = c("effect", "change_M", "breakdown"),
        "Undirvísitala" = c("*")
    ),
    verbose = FALSE
) |> 
    as.data.frame() |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    separate(manudur, into = c("ar", "manudur"), sep = "M", convert = T) |> 
    mutate(manudur = str_pad(manudur, width = 2, side = "left", pad = "0"),
           date = str_c(ar, "-", manudur, "-01") |> ymd(),
           visitala_neysluverds = visitala_neysluverds / 100) |> 
    select(date, undirvisitala, lidur, value = visitala_neysluverds) |> 
    filter(str_detect(undirvisitala, "^[0-9]{2} |Vísitala neysluverðs")) |>
    arrange(date) |> 
    mutate(undirvisitala = str_replace(undirvisitala, "^[0-9]{2} ", ""),
           lidur = fct_recode(lidur,
                              "vaegi" = "Vægi, %",
                              "breyting" = "Mánaðarbreyting, %",
                              "ahrif" = "Áhrif á vísitölu, %")) |> 
    pivot_wider(names_from = lidur, values_from = value)
```

```{r}
#| include: false
#| eval: false
#| echo: false


plot_dat <- d |> 
    filter(undirvisitala != "Vísitala neysluverðs",
           date %in% tail(unique(date), 12)) |> 
    group_by(undirvisitala) |> 
    summarise(vaegi = sum(vaegi),
              breyting = sum(breyting),
              ahrif = sum(ahrif),
              .groups = "drop") |> 
    mutate(vaegi = vaegi / sum(vaegi)) |> 
    mutate(fill = fct_reorder(undirvisitala, ahrif),
           undirvisitala = str_wrap(undirvisitala, width = 20),
           undirvisitala = fct_reorder(undirvisitala, breyting)) |> 
    arrange(desc(undirvisitala)) |> 
    mutate(vaegi = cumsum(vaegi),
           x_min = lag(vaegi, default = 0),
           x_max = vaegi,
           y_min = 0,
           y_max = breyting,
           area = (y_max - y_min) * (x_max - x_min))

plot_dat |> 
    ggplot(aes(xmin = x_min, xmax = x_max,
               ymin = y_min, ymax = y_max)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_rect(aes(fill = fill)) +
    geom_rangeframe(aes(y = y_max)) +
    scale_x_continuous(labels = label_percent(),
                       expand = expansion()) +
    scale_y_continuous(labels = label_percent(),
                       expand = expansion()) +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = "Vægi",
         y = "Breyting")




```


# Undirvísitölur 

Í grófum dráttum er vísitala neysluverðs vegið meðaltal af breytingu í verði hinna ýmsu afurða sem við kaupum. Því eru t.d. áhrif breytingar á húsnæðisverði reiknuð með því að margfalda verðbreytingar þess flokks við vægi hans í vísitölunni. Vægið á að endurspegla útgjöld einhvers konar meðal-Íslendings.

Færið músina yfir myndirnar til að sjá nákvæm tölugildi og hvaða litir tilheyra hvaða flokkum.

:::{.panel-tabset}

## Vísitala

Dragið rennuna undir myndinni til að þysja inn á tiltekið tímabil.

```{r}
#| fig.width: 10
#| fig.asp: 0.8
#| out.width: "100%"
#| 
roll_fun <- function(x) {
    x <- log(1 + x)
    out <- x
    
    for (i in 1:11) out <- out + lag(x, n = i)
    
    exp(out) - 1
}


plot_dat <- d |> 
    arrange(date) |> 
    group_by(undirvisitala) |> 
    mutate(year_ahrif = roll_fun(ahrif),
           year_breyting = roll_fun(breyting)) |> 
    ungroup() |> 
    filter(year(date) >= 2012) |> 
    mutate(undirvisitala = fct_reorder(undirvisitala, year_ahrif, .fun = sum),
           text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "\n",
                        "Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "\n",
                        "Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "\n",
                        "<b>Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "</b>\n",
                        "<b>Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01), "</b>"))



p <- plot_dat |> 
    filter(undirvisitala != "Vísitala neysluverðs") |> 
    ggplot(aes(date, year_ahrif, text = text)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = undirvisitala, col = undirvisitala), position = "stack", width = 30) +
    geom_line(data = plot_dat |> 
                  filter(undirvisitala == "Vísitala neysluverðs") |> 
                  mutate(text = str_c("<b>", undirvisitala, "</b>\n",
                                      "Dagsetning: ", format(date, "%B, %Y"), "\n",
                                      "Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "\n",
                                      "Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "\n",
                                      "Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "\n",
                                      "<b>Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "</b>\n",
                                      "<b>Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01), "</b>\n")), 
              aes(group = "none")) +
    scale_x_date(expand = expansion(),
                 date_breaks = "year",
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(-0.02, 0, 0.04, 0.06, 0.08, 0.1)) +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Árleg breyting vísitölu og áhrif undirtalna (2012-2022)")

ggsave(plot = p, filename = "undirtolur.png",
       width = 8, height = 0.621 * 8, scale = 1, bg = "white")

ggplotly(
    p,
    tooltip = "text"
) |> 
    layout(hoverlabel = list(align = "left"),
           xaxis = list(
               rangeslider = list(type = "date")
           )
    )
```

## Vægi

Dragið rennuna undir myndinni til að þysja inn á tiltekið tímabil.

```{r}
#| fig.width: 10
#| fig.asp: 0.8
#| out.width: "100%"
#| 
roll_fun <- function(x) {
    x <- log(1 + x)
    out <- x
    
    for (i in 1:11) out <- out + lag(x, n = i)
    
    exp(out) - 1
}


plot_dat <- d |> 
    arrange(date) |> 
    group_by(undirvisitala) |> 
    mutate(year_ahrif = roll_fun(ahrif),
           year_breyting = roll_fun(breyting)) |> 
    ungroup() |> 
    filter(year(date) >= 2012) |> 
    mutate(undirvisitala = fct_reorder(undirvisitala, year_ahrif, .fun = sum),
           text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "\n",
                        "Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "\n",
                        "<b>Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "</b>\n",
                        "Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "\n",
                        "Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01)))



p <- plot_dat |> 
    filter(undirvisitala != "Vísitala neysluverðs") |> 
    ggplot(aes(date, vaegi, text = text)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = undirvisitala, col = undirvisitala), position = "stack", width = 30) +
    scale_x_date(expand = expansion(),
                 date_breaks = "year",
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = pretty_breaks(8),
                       expand = expansion()) +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Vægi undirflokka í vísitölu neysluverðs (2012-2022)")

ggplotly(
    p,
    tooltip = "text"
) |> 
    layout(hoverlabel = list(align = "left"),
           xaxis = list(
               rangeslider = list(type = "date")
           ))
```

## Verðbreyting

```{r}
#| fig.width: 10
#| fig.asp: 1.2
#| out.width: "100%"
#| 
roll_fun <- function(x) {
    x <- log(1 + x)
    out <- x
    
    for (i in 1:11) out <- out + lag(x, n = i)
    
    exp(out) - 1
}


plot_dat <- d |> 
    arrange(date) |> 
    group_by(undirvisitala) |> 
    mutate(year_ahrif = roll_fun(ahrif),
           year_breyting = roll_fun(breyting)) |> 
    ungroup() |> 
    filter(year(date) >= 2012) |> 
    mutate(undirvisitala = fct_reorder(undirvisitala, year_ahrif, .fun = sum),
           text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "<b>Hrein breyting (ár): ", percent(year_breyting, accuracy = 0.01), "</b>\n",
                        "<b>Hrein breyting (mánuður): ", percent(breyting, accuracy = 0.01), "</b>\n",
                        "Vægi í vísitölu: ", percent(vaegi, accuracy = 0.01), "\n",
                        "Áhrif á vísitölu (ár): ", percent(year_ahrif, accuracy = 0.01), "\n",
                        "Áhrif á vísitölu (mánuður): ", percent(ahrif, accuracy = 0.01)))



p <- plot_dat |> 
    filter(undirvisitala != "Vísitala neysluverðs") |> 
    ggplot(aes(date, year_breyting, text = text)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_col(aes(fill = undirvisitala, col = undirvisitala), width = 30) +
    scale_x_date(expand = expansion(),
                 date_breaks = "2 year",
                 date_labels = "%Y") +
    scale_y_continuous(labels = label_percent(),
                       breaks = pretty_breaks(8)) +
    scale_colour_brewer(type = "qual", palette = "Paired") +
    scale_fill_brewer(type = "qual", palette = "Paired") +
    facet_wrap("undirvisitala", ncol = 3) +
    theme_half_open() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Árleg verðbreyting á undirflokkum vísitölu neysluverðs (2012-2022)")

ggplotly(
    p,
    tooltip = "text"
) |> 
    layout(hoverlabel = list(align = "left"))
```

:::

# Árleg breyting og mánaðarleg breyting

Þar sem árleg verðbólga samanstendur af verðbólgu síðustu 12 mánaða getur ekki hver og einn mánuður lækkað hana mikið. Ef mánaðarleg verðbólga síðustu 11 mánuði hefur verið 0,5% en hún mælist svo 0% verður árleg verðbólgan samt $1,005^{11} = 1,056 = 5,6\%$. Hins vegar getur verið gott að bera saman mánaðarlega verðbólgi við meðaltal síðastliðins árs. Ef mánaðarleg verðbólga er lægri en meðaltal síðasta árs er árleg verðbólga að lækka.

```{r}
#| fig.width: 10
#| fig.asp: 0.621
#| out.width: "100%"
#| 
p <- plot_dat |> 
    mutate(text = str_c("<b>", undirvisitala, "</b>\n",
                        "Dagsetning: ", format(date, "%B, %Y"), "\n",
                        "<b>Árleg (deilt með 12): ", percent(year_breyting/12, accuracy = 0.01), "\n</b>",
                        "<b>Mánaðarleg: ", percent(breyting, accuracy = 0.01), "</b>")) |> 
    filter(undirvisitala == "Vísitala neysluverðs",
           date >= ymd("2020-08-01")) |> 
    ggplot(aes(year_ahrif/12, ahrif, text = text)) +
    geom_abline(intercept = 0, slope = 1, lty = 2) +
    geom_path(aes(group = "none")) +
    scale_x_continuous(labels = label_percent()) +
    scale_y_continuous(labels = label_percent()) +
    coord_cartesian(ylim = c(0, 0.17)/12, xlim = c(0, 0.17)/12,
                    expand = F) +
    theme_half_open() +
    labs(x = "Árleg verðbólga (deilt með 12)",
         y = "Mánaðarleg verðbólga",
         title = "Árleg verðbólga á móti mánaðarlegri verðbólgu (ágúst 2020 - ágúst 2022)")

ggplotly(
    p,
    tooltip = "text"
)
```

