---
title: "Laus störf"
subtitle: "Nánari skoðun á gögnum Hagstofunnar um laus störf eftir atvinnugreinum og ársfjórðungum"
description: |
    Hagstofan birtir reglulega uppfærð gögn um fjölda og hlutfall lausra starfa eftir atvinnugreinum. Þar sem þessi gögn voru uppfærð í dag datt mér í hug að setja saman stutta samantekt á þeim sem ég get svo auðveldlega uppfært þegar gögnin sjálf eru uppfærð.
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: "2022/08/18"
format: 
    html:
        code-fold: true
        toc: true
        toc-depth: 2
        toc-location: right
        toc-title: Efnisyfirlit
        page-layout: full
        smooth-scroll: true
        link-external-newwindow: true
        include-after-body: footer.html
execute: 
  echo: true
  warning: false
  cache: false
editor: source
title-block-banner: true
draft: false
categories:
    - vinnumarkaður
    - efnahagur
    - Hagstofa
    - R
    - íslenska
image: fig.png
twitter-card: 
    image: fig.png
---

```{r}
#| include: false

library(cowplot)
library(tidyverse)
library(scales)
library(pxweb)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(readxl)
library(janitor)
library(plotly)
```

Hér nota ég gögn Hagstofu um [Laus störf eftir ársfjórðungum og atvinnugreinum 2019-2022](https://px.hagstofa.is/pxis/pxweb/is/Samfelag/Samfelag__vinnumarkadur__lausstorf/JVS00001.px). Eins og í öðrum Hagstofufærslum mínum er hægt að smella á `Code` hér að neðan til að sjá hvernig ég sæki gögnin í gegnum [pxweb kerfið](http://ropengov.github.io/pxweb/).



```{r}
d <- pxweb_get_data("https://px.hagstofa.is:443/pxis/api/v1/is/Samfelag/vinnumarkadur/lausstorf/JVS00001.px", 
                    query = list(
                        "Ársfjórðungur" = c("*"),
                        "Atvinnugrein" = c("*"),
                        "Eining" = c("*")
                    )) |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    rename(value = 4) |> 
    mutate(af = arsfjordungur) |> 
    separate(arsfjordungur, into = c("ar", "man"), sep = "Á", convert = T) |> 
    mutate(man = 1 + (man - 1) * 3,
           dags = str_c(ar, "-", str_pad(man, width = 2, side = "left", pad = "0"), "-01") |> ymd()) |> 
    select(dags, af, atvinnugrein, eining, value) |> 
    # filter(str_detect(eining, "Hlutfa|Fjöldi starfa")) |> 
    mutate(eining = case_when(str_detect(eining, "Hlutfa") ~ "hlutf_laus",
                              eining == "Fjöldi starfa" ~ "fjoldi",
                              TRUE ~ "fjoldi_laus")) |> 
    select(dags, af, atvinnugrein, eining, value) |> 
    pivot_wider(names_from = eining, values_from = value) |> 
    mutate(hlutf_laus = hlutf_laus / 100)

facet_strip_bigger <- function(gp, size){
    if(missing(gp)){
        print("this function needs a facet_wrap ggplotly object")
    }
    if(missing(size)){
        print("this function needs 'size' argument to be specified as integer. 80 will be introduced as default")
        size <- 80
    }
    
    n_facets <- c(1:length(gp[["x"]][["layout"]][["shapes"]]))
    
    for(i in n_facets){
        if(n_facets[i] %% 2 == 0){
            gp[["x"]][["layout"]][["shapes"]][[i]][["y0"]] <- + as.numeric(size)
            gp[["x"]][["layout"]][["shapes"]][[i]][["y1"]] <- 0
        }
    }
    
    return(gp)
}

theme_set(
    theme_half_open(font_size = 12) +
        theme(panel.spacing.y = unit(0.1, "cm"),
              plot.margin = margin(t = 5, r = 5, b = 15, l = 5))
)
```

# Laus störf eftir atvinnugreinum


:::{.panel-tabset}

## Hlutfall lausra starfa

```{r}
#| fig-width: 12
#| fig-asp: 3
#| out-width: "100%"

plot_dat <- d |> 
    filter(atvinnugrein != "Alls") |> 
    mutate(atvinnugrein = str_wrap(atvinnugrein, width = 100),
           text = str_c("<b>", atvinnugrein, "</b>", "\n",
                        "Dags: ", af, "\n" ,
                        "<b>Hlutfall laus: ", percent(hlutf_laus, accuracy = 0.1, decimal.mark = ",", big.mark = "."), "</b>", "\n",
                        "Fjöldi starfa: ", number(fjoldi, big.mark = ".", decimal.mark = ",", accuracy = 1), "\n",
                        "Fjöldi lausra starfa: ", number(fjoldi_laus, big.mark = ".", decimal.mark = ",", accuracy = 1)))

p <- plot_dat |> 
    ggplot(aes(dags, hlutf_laus, text = text)) +
    geom_line(data = plot_dat |> rename(atv = atvinnugrein),
              aes(group = atv), alpha = 0.1) +
    geom_line(aes(group = atvinnugrein)) +
    scale_y_continuous(labels = label_percent()) +
    facet_wrap("atvinnugrein", ncol = 1, scales = "free_x") +
    labs(x = NULL, y = NULL)

ggplotly(
    p,
    tooltip = "text") |> 
    layout(hoverlabel = list(align = "left"))
```


## Fjöldi starfa

:::{.panel-tabset}

### Atvinnugrein

```{r}
#| fig-width: 12
#| fig-asp: 3
#| out-width: "100%"

plot_dat <- d |> 
    filter(atvinnugrein != "Alls") |> 
    mutate(atvinnugrein = str_wrap(atvinnugrein, width = 100),
           text = str_c("<b>", atvinnugrein, "</b>", "\n",
                        "Dags: ", af, "\n" ,
                        "Hlutfall laus: ", percent(hlutf_laus, accuracy = 0.1, decimal.mark = ",", big.mark = "."), "\n",
                        "<b>Fjöldi starfa: ", number(fjoldi, big.mark = ".", decimal.mark = ",", accuracy = 1), "</b>", "\n",
                        "Fjöldi lausra starfa: ", number(fjoldi_laus, big.mark = ".", decimal.mark = ",", accuracy = 1)))

p <- plot_dat |> 
    ggplot(aes(dags, fjoldi, text = text)) +
    # geom_line(data = plot_dat |> rename(atv = atvinnugrein),
    #           aes(group = atv), alpha = 0.1) +
    geom_line(aes(group = atvinnugrein)) +
    scale_y_log10(labels = label_number(big.mark = ".", decimal.mark = ",", accuracy = 1)) +
    facet_wrap("atvinnugrein", ncol = 1, scales = "free") +
    labs(x = NULL, y = NULL)

ggplotly(
    p,
    tooltip = "text") |> 
    layout(hoverlabel = list(align = "left"))
```

### Í samhengi

```{r}
#| fig-width: 12
#| fig-asp: 3
#| out-width: "100%"

plot_dat <- d |> 
    filter(atvinnugrein != "Alls") |> 
    mutate(atvinnugrein = str_wrap(atvinnugrein, width = 100),
           text = str_c("<b>", atvinnugrein, "</b>", "\n",
                        "Dags: ", af, "\n" ,
                        "Hlutfall laus: ", percent(hlutf_laus, accuracy = 0.1, decimal.mark = ",", big.mark = "."), "\n",
                        "<b>Fjöldi starfa: ", number(fjoldi, big.mark = ".", decimal.mark = ",", accuracy = 1), "</b>", "\n",
                        "Fjöldi lausra starfa: ", number(fjoldi_laus, big.mark = ".", decimal.mark = ",", accuracy = 1)))

p <- plot_dat |> 
    ggplot(aes(dags, fjoldi, text = text)) +
    geom_line(data = plot_dat |> rename(atv = atvinnugrein),
              aes(group = atv), alpha = 0.1) +
    geom_line(aes(group = atvinnugrein)) +
    scale_y_log10(labels = label_number(big.mark = ".", decimal.mark = ",", accuracy = 1)) +
    facet_wrap("atvinnugrein", ncol = 1, scales = "free_x") +
    labs(x = NULL, y = NULL)

ggplotly(
    p,
    tooltip = "text") |> 
    layout(hoverlabel = list(align = "left"))
```

:::

## Fjöldi lausra starfa

:::{.panel-tabset}

### Atvinnugrein

```{r}
#| fig-width: 12
#| fig-asp: 3
#| out-width: "100%"

plot_dat <- d |> 
    filter(atvinnugrein != "Alls") |> 
    mutate(atvinnugrein = str_wrap(atvinnugrein, width = 100),
           text = str_c("<b>", atvinnugrein, "</b>", "\n",
                        "Dags: ", af, "\n" ,
                        "Hlutfall laus: ", percent(hlutf_laus, accuracy = 0.1, decimal.mark = ",", big.mark = "."), "\n",
                        "Fjöldi starfa: ", number(fjoldi, big.mark = ".", decimal.mark = ",", accuracy = 1), "\n",
                        "<b>Fjöldi lausra starfa: ", number(fjoldi_laus, big.mark = ".", decimal.mark = ",", accuracy = 1), "</b>"))

p <- plot_dat |> 
    ggplot(aes(dags, fjoldi_laus, text = text)) +
    # geom_line(data = plot_dat |> rename(atv = atvinnugrein),
    #           aes(group = atv), alpha = 0.1) +
    geom_line(aes(group = atvinnugrein)) +
    scale_y_continuous(labels = label_number(big.mark = ".", decimal.mark = ",", accuracy = 1)) +
    facet_wrap("atvinnugrein", ncol = 1, scales = "free") +
    labs(x = NULL, y = NULL)

ggplotly(
    p,
    tooltip = "text") |> 
    layout(hoverlabel = list(align = "left"))
```

### Samhengi

```{r}
#| fig-width: 12
#| fig-asp: 3
#| out-width: "100%"

plot_dat <- d |> 
    filter(atvinnugrein != "Alls") |> 
    mutate(atvinnugrein = str_wrap(atvinnugrein, width = 100),
           text = str_c("<b>", atvinnugrein, "</b>", "\n",
                        "Dags: ", af, "\n" ,
                        "Hlutfall laus: ", percent(hlutf_laus, accuracy = 0.1, decimal.mark = ",", big.mark = "."), "\n",
                        "Fjöldi starfa: ", number(fjoldi, big.mark = ".", decimal.mark = ",", accuracy = 1), "\n",
                        "<b>Fjöldi lausra starfa: ", number(fjoldi_laus, big.mark = ".", decimal.mark = ",", accuracy = 1), "</b>"))

p <- plot_dat |> 
    ggplot(aes(dags, fjoldi_laus, text = text)) +
    geom_line(data = plot_dat |> rename(atv = atvinnugrein),
              aes(group = atv), alpha = 0.1) +
    geom_line(aes(group = atvinnugrein)) +
    scale_y_continuous(labels = label_number(big.mark = ".", decimal.mark = ",", accuracy = 1)) +
    facet_wrap("atvinnugrein", ncol = 1, scales = "free") +
    labs(x = NULL, y = NULL)

ggplotly(
    p,
    tooltip = "text") |> 
    layout(hoverlabel = list(align = "left"))
```

:::

:::

# Kóði fyrir þumalmynd færslunnar

Í hverri færslu get valið mynd sem birtist í smærri útgáfu. Mér datt í hug að hafa kóðann fyrir þá mynd í lokin á færslunni fyrir áhugasama. Þar sem `plotly` býður ekki upp á jafn góða hönnunarstaðla og `ggplot2` eru þessar myndir oft aðeins fallegri en gagnvirku `plotly` myndirnar. 

```{r}
#| fig-width: 10
#| fig-height: 10


plot_dat <- d |> 
    filter(atvinnugrein != "Alls") |> 
    mutate(atvinnugrein = str_wrap(atvinnugrein, width = 60))

p <- plot_dat |> 
    ggplot(aes(dags, hlutf_laus)) +
    geom_line(data = plot_dat |> rename(atv = atvinnugrein),
              aes(group = atv), alpha = 0.1) +
    geom_line(aes(group = atvinnugrein)) +
    geom_rangeframe(sides = "l") +
    geom_rangeframe(data = plot_dat |> filter(str_detect(atvinnugrein, "R-S|M-N|O-Q")), sides = "b") +
    scale_y_continuous(labels = label_percent()) +
    facet_wrap("atvinnugrein", ncol = 3) +
    theme_tufte() +
    theme(strip.background = element_rect(fill = "grey90"),
          plot.title = element_text(face = "bold")) +
    labs(x = NULL, y = NULL,
         title = "Hlutfall lausra starfa eftir atvinnugrein")

ggsave(plot = p, filename = "fig.png",
       width = 8, height = 1 * 8, scale = 1.3, bg = "white")

p
```

