---
title: "Fjármál stjórnmálaflokkanna"
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: "2022/09/17"
format: 
    html:
        code-fold: true
        toc: true
        toc-depth: 2
        toc-location: right
        toc-title: Efnisyfirlit
        page-layout: full
        smooth-scroll: true
        link-external-newwindow: true
execute: 
  echo: true
  warning: false
  cache: false
editor: source
draft: true
title-block-banner: true
categories:
    - stjórnmál
    - efnahagur
    - ársreikningar
    - R
    - íslenska
image: image.png

---


```{r}
#| include: false

library(cowplot)
library(tidyverse)
library(scales)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(readxl)
library(janitor)
library(plotly)
library(config)
library(DBI)
library(visitalaneysluverds)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(cowplot)
library(scales)
library(visitalaneysluverds)
library(feather)
library(gganimate)

title <- "#08306b"
subtitle <- "#4A4C45"
caption <- "grey60"

axis_text <- "#4A4C45"
axis_title <- "black"

strip_background <- "#e0e0e0"
background <- "#ffffff"




main_font <- "Lato"
axis_title_font <- NULL
axis_line_col <- "#403d39"



base_size <- 14

theme_set(
    theme(
        text = element_text(family = main_font, size = base_size),
        plot.title = element_text(
            face = "bold",
            colour = title,
            size = base_size * 1.4,
            hjust = 0,
            margin = margin(t = 0, r = 0, b = 5, l = 0)
        ),
        plot.subtitle = element_text(
            colour = subtitle,
            size = base_size * 1,
            hjust = 0,
            margin = margin(t = 0, r = 0, b = 5, l = 5)
        ),
        plot.caption = element_text(
            colour = caption,
            hjust = 1,
            size = 0.5 * base_size
        ),
        plot.caption.position = "panel",
        panel.background = element_rect(fill = background, colour = NA),
        plot.background = element_rect(fill = background, colour = NA),
        panel.grid = element_blank(),
        axis.title = element_text(
            size = base_size ,
            family = axis_title_font,
            color = "black",
            vjust = 1,
            margin = margin(t = 0, r = 0, b = 0, l = 0)
        ),
        axis.text = element_text(
            size = base_size * 0.7,
            colour = axis_text
        ),
        axis.line = element_line(
            colour = "black"
        ),
        # axis.line = element_blank(),
        axis.ticks = element_line(
            size = 0.6,
            colour = axis_line_col
        ),
        strip.background = element_rect(
            fill = strip_background,
            colour = NA,
        ),
        plot.margin = margin(t = 5, r = 5, b = 5, l = 5)
    )
)

```

```{r}
usr <- config::get("postgres_user")
con <- dbConnect(RPostgres::Postgres(), 
                 dbname = usr$dbname, 
                 host = usr$host,
                 port = usr$port, 
                 user = usr$username, 
                 password = usr$password)

isk <- function(x, scale = 1e6, suffix = " mkr") number(x / scale, suffix = suffix, big.mark = ".", decimal.mark = ",")
hlutf <- label_percent(accuracy = 0.1, big.mark = ".", decimal.mark = ",")
```


```{r}
d <- tbl(con, "arsreikningar_stjornmalaflokka") |> 
    collect() |> 
    mutate_all(~ ifelse(is.na(.), 0, .)) |> 
    inner_join(
        vnv() |> 
            group_by(ar = year(date)) |> 
            summarise(cpi = mean(cpi)) |> 
            mutate(cpi = cpi / cpi[ar == max(ar)]),
        by = "ar"
    )

xS <- "#e41a1c"
xV <- "#238b45"
xD <- "#377eb8"
xP <- "#984ea3"
xB <- "#b2df8a"
xBF <- "#cab2d6"
xC <- "#ff7f00"
xM <- "#08306b"
xFF <- "#fee391"
Annad <- "#e5d8bd"

colours <- tibble(
    flokkur = c(
        "Sjálfstæðisflokkur",
        "Framsóknarflokkurinn",
        "Samfylkingin",
        "Vinstrihreyfingin - grænt framboð",
        "Viðreisn",
        "Píratar",
        "Miðflokkurinn",
        "Flokkur Fólksins"
    ),
    colour = c(
        xD,
        xB,
        xS,
        xV,
        xC,
        xP,
        xM,
        xFF
    )
)

d <- d |> 
    inner_join(
        colours,
        by = "flokkur"
    )

```


```{r}
dreifing_plot <- function(data, title) {
    plot_dat <- data |> 
        select(ar, flokkur, value, colour) |> 
        group_by(ar) |> 
        mutate(p = value / sum(value)) |> 
        ungroup() |> 
        mutate(
            flokkur = fct_reorder(flokkur, value, .fun = sum),
            text = str_c(
                "<b>", flokkur, "</b>", "\n",
                "Ár: ", ar, "\n",
                "Upphæð: ", isk(value), "\n",
                "<b>% upphæða: ", hlutf(p), "</b>"
            )
        )
    
    
    p <- plot_dat |> 
        ggplot(aes(ar, value, text = text)) +
        geom_col(aes(fill = flokkur), position = "fill", colour = "grey95", width = 1) +
        scale_x_continuous(breaks = 2007:2020) +
        scale_y_continuous(labels = hlutf) +
        scale_fill_manual(
            values = c(
                plot_dat |> arrange(flokkur) |> distinct(colour) |> pull(colour)
            )
        ) +
        coord_cartesian(expand = FALSE) +
        # theme_half_open() +
        theme(legend.position = "none") +
        labs(x = NULL, y = NULL, fill = NULL,
             title = title)
    
    ggplotly(
        p,
        tooltip = "text"
    ) |> 
        layout(
            hoverlabel = list(align = "left")
        )
}

magn_plot <- function(data, title) {
    plot_dat <- data |> 
        select(ar, flokkur, value, colour) |> 
        group_by(ar) |> 
        mutate(p = value / sum(value)) |> 
        ungroup() |> 
        mutate(
            flokkur = fct_reorder(flokkur, value, .fun = sum),
            text = str_c(
                "<b>", flokkur, "</b>", "\n",
                "Ár: ", ar, "\n",
                "<b>Upphæð: ", isk(value), "</b>", "\n",
                "% upphæða: ", hlutf(p)
            )
        )
    
    
    p <- plot_dat |> 
        ggplot(aes(ar, value, text = text)) +
        geom_col(aes(fill = flokkur), position = "stack", colour = "grey95", width = 1) +
        scale_x_continuous(breaks = 2007:2020) +
        scale_y_continuous(labels = isk) +
        scale_fill_manual(
            values = c(
                plot_dat |> arrange(flokkur) |> distinct(colour) |> pull(colour)
            )
        ) +
        coord_cartesian(expand = FALSE) +
        # theme_half_open() +
        theme(legend.position = "none") +
        labs(x = NULL, y = NULL, fill = NULL,
             title = title)
    
    ggplotly(
        p,
        tooltip = "text"
    ) |> 
        layout(
            hoverlabel = list(align = "left")
        )
}
```



# Framlög til stjórnmálaflokka

## Ríkissjóður

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = (framlog_rikis + framlog_althingi) / cpi) |> 
    dreifing_plot(title = "Dreifing framlaga ríkissjóðs á stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = (framlog_rikis + framlog_althingi) / cpi) |> 
    magn_plot(title = "Framlög ríkissjóðs til stjórnmálaflokka (2007 - 2020)")
```

:::


## Sveitarfélög

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_svf / cpi) |> 
    dreifing_plot(title = "Dreifing framlaga sveitarfélaga til stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_svf / cpi) |> 
    magn_plot(title = "Framlög sveitarfélaga til stjórnmálaflokka (2007 - 2020)")
```

:::

## Opinber framlög alls

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_althingi + framlog_rikis + framlog_svf,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing framlaga hins opinbera til stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_althingi + framlog_rikis + framlog_svf,
           value = value / cpi) |> 
    magn_plot(title = "Framlög hins opinbera til stjórnmálaflokka (2007 - 2020)")
```

:::

## Fyrirtæki og lögaðilar

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_fyrirtaekja,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing framlaga fyrirtækja/lögaðila til stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_fyrirtaekja,
           value = value / cpi) |> 
    magn_plot(title = "Framlög fyrirtækja/lögaðila til stjórnmálaflokka (2007 - 2020)")
```

### Magn (Án 2007)

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_fyrirtaekja,
           value = value / cpi) |> 
    filter(ar > 2007) |> 
    magn_plot(title = "Framlög fyrirtækja/lögaðila til stjórnmálaflokka (2008 - 2020)")
```

:::

## Einstaklingar

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_einstaklinga,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing framlaga einstaklinga til stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = framlog_einstaklinga,
           value = value / cpi) |> 
    magn_plot(title = "Framlög einstaklinga til stjórnmálaflokka (2007 - 2020)")
```

:::

## Aðrar tekjur

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = adrar_tekjur,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing annarra tekna stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = adrar_tekjur,
           value = value / cpi) |> 
    magn_plot(title = "Aðrar tekjur stjórnmálaflokka (2007 - 2020)")
```

:::

## Heildartekjur

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = tekjur,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing heildartekna til stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = tekjur,
           value = value / cpi) |> 
    magn_plot(title = "Heildartekjur stjórnmálaflokka (2007 - 2020)")
```

:::


# Eignir, skuldir og eigið fé

## Eignir

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = eignir,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing eigna stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = eignir,
           value = value / cpi) |> 
    magn_plot(title = "Eignir stjórnmálaflokka (2007 - 2020)")
```

:::

## Skuldir

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = skuldir,
           value = value / cpi) |> 
    dreifing_plot(title = "Dreifing skulda stjórnmálaflokka (2007 - 2020)")

```

### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = skuldir,
           value = value / cpi) |> 
    magn_plot(title = "Skuldir stjórnmálaflokka (2007 - 2020)")
```

:::

## Eigið fé

::: {.panel-tabset}

### Dreifing

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = eignir - skuldir,
           value = value / cpi) |> 
    mutate(value = value * (value >= 0)) |> 
    dreifing_plot(title = "Dreifing eigin fjár stjórnmálaflokka (2007 - 2020)")

```




### Magn

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| column: page

d |> 
    mutate(value = eignir - skuldir,
           value = value / cpi) |> 
    magn_plot(title = "Eigið fé stjórnmálaflokka (2007 - 2020)")
```

:::

```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| include: false

plot_dat <- d |> 
    mutate(value = (eignir - skuldir) / cpi) |> 
    select(ar, flokkur, value, colour) |> 
    group_by(ar) |> 
    mutate(p = value / sum(value)) |> 
    ungroup() |> 
    mutate(
        flokkur = str_to_sentence(flokkur),
        flokkur = fct_reorder(flokkur, value, .fun = mean)
    )


p <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(aes(fill = flokkur), position = "stack", colour = "grey95", width = 1) +
    scale_x_continuous(breaks = 2007:2020) +
    scale_y_continuous(labels = isk) +
    scale_fill_manual(
        values = c(
            plot_dat |> arrange(flokkur) |> distinct(colour) |> pull(colour)
        )
    ) +
    coord_cartesian(expand = FALSE) +
    guides(fill = guide_legend(reverse = T)) +
    theme(legend.position = "top") +
    labs(x = NULL, y = NULL, fill = NULL,
         title = "Eigið fé íslenskra stjórnmálaflokka",
         subtitle = "Árið 2007 átti Sjálfstæðisflokkur 100% alls eigin fjár flokkanna en 2020 á hann 43,5%",
         caption = "Mynd eftir @bggjonsson unnin úr ársreikningum stjórnmálaflokka frá Ríkisendurskoðun")

ggsave(plot = p, filename = "Figures/eigidfe.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```





```{r}
#| fig-asp: 0.621
#| fig-width: 10
#| out-width: "100%"
#| include: false
#| eval: false
#| column: page




plot_dat <- d |> 
    mutate(
        value = ifelse(
            flokkur == "Sjálfstæðisflokkur", 
            leigutekjur,
            gjold
        ),
        value = value / cpi
    ) |> 
    filter(
        flokkur %in% c("Sjálfstæðisflokkur", "Flokkur Fólksins", "Viðreisn"),
        ar >= 2015
    ) |> 
    mutate(y = value,
           # y = case_when(
           #     flokkur == "Flokkur Fólksins" ~ y * 1.006,
           #     flokkur == "Viðreisn" ~ y * 0.992,
           #     flokkur == "Sjálfstæðisflokkur" ~ y * 0.994,
           #     TRUE ~ y
           # ),
           label = ifelse(
               flokkur == "Sjálfstæðisflokkur",
               "**Sjálfstæðisflokkur** (Leigutekjur)",
               str_c(flokkur, " (Útgjöld)")
           )
    )

p <- plot_dat |> 
    ggplot(aes(ar, value, colour = flokkur)) +
    geom_line() +
    geom_richtext(
        data = plot_dat |> filter(ar == max(ar)),
        aes(label = label, y = y),
        hjust = 0,
        nudge_x = 0.05,
        fill = NA, label.color = NA
    ) +
    scale_x_continuous(limits = c(2014.8, 2021.9),
                       expand = expansion(),
                       breaks = c(2015:2020)) +
    scale_y_continuous(labels = isk,
                       breaks = pretty_breaks(4),
                       limits = c(0, 80e6),
                       expand = expansion()) +
    scale_colour_manual(
        values = c(xFF, xD, xC)
    ) +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Leigutekjur Sjálfstæðisflokks og útgjöld minni flokka",
         subtitle = "Sjálfstæðisflokkur fengi nægar tekjur af útleigu fasteigna til að fjármagna Flokk floksins")

ggsave(plot = p, filename = "Figures/samanburdur.png",
       width = 8, height = 0.5 * 8, scale = 1.2, bg = "white")
```

# Þumalmynd

Ég hef alltaf þumalmynd sem fylgir færslunni á síðunni minni. Hér er kóðinn sem ég nota til að búa hana til og vista hana.

```{r}
#| fig-width: 10
#| fig.asp: 1
#| out-width: "100%"
#| column: page

plot_dat <- d |> 
    mutate(value = (framlog_rikis + framlog_althingi + framlog_svf) / cpi) |> 
    select(ar, flokkur, value, colour) |> 
    group_by(ar) |> 
    mutate(p = value / sum(value),
           flokkur = fct_reorder(flokkur, value, .fun = sum)) |> 
    ungroup() 


p1 <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(aes(fill = flokkur), position = "stack", colour = "grey95", width = 1) +
    scale_x_continuous(breaks = 2007:2020) +
    scale_y_continuous(labels = isk) +
    scale_fill_manual(
        values = c(
            plot_dat |> arrange(flokkur) |> distinct(colour) |> pull(colour)
        )
    ) +
    coord_cartesian(expand = FALSE) +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          # axis.line.x = element_blank(),
          axis.ticks.x = element_blank()) +
    labs(x = NULL, y = NULL, fill = NULL,
         title = "Samanburður á fjármálum stjórnmálaflokka",
         subtitle = "Opinber framlög")

plot_dat <- d |> 
    mutate(value = framlog_fyrirtaekja / cpi) |> 
    select(ar, flokkur, value, colour) |> 
    group_by(ar) |> 
    mutate(p = value / sum(value),
           flokkur = fct_reorder(flokkur, value, .fun = sum)) |> 
    ungroup() 


p2 <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(aes(fill = flokkur), position = "stack", colour = "grey95", width = 1) +
    scale_x_continuous(breaks = 2007:2020) +
    scale_y_continuous(labels = isk) +
    scale_fill_manual(
        values = c(
            plot_dat |> arrange(flokkur) |> distinct(colour) |> pull(colour)
        )
    ) +
    coord_cartesian(expand = FALSE) +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          # axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          plot.margin = margin(t = 5, r = 5, b = 5, l = 12)) +
    labs(x = NULL, y = NULL, fill = NULL,
         title = NULL,
         subtitle = "Framlög fyrirtækja")

plot_dat <- d |> 
    mutate(value = framlog_einstaklinga / cpi) |> 
    select(ar, flokkur, value, colour) |> 
    group_by(ar) |> 
    mutate(p = value / sum(value),
           flokkur = fct_reorder(flokkur, value, .fun = sum)) |> 
    ungroup() 


p3 <- plot_dat |> 
    ggplot(aes(ar, value)) +
    geom_col(aes(fill = flokkur), position = "stack", colour = "grey95", width = 1) +
    scale_x_continuous(breaks = 2007:2020) +
    scale_y_continuous(labels = isk) +
    scale_fill_manual(
        values = c(
            plot_dat |> arrange(flokkur) |> distinct(colour) |> pull(colour)
        )
    ) +
    coord_cartesian(expand = FALSE) +
    theme(legend.position = "none",
          plot.margin = margin(t = 5, r = 5, b = 5, l = 12)) +
    labs(x = NULL, y = NULL, fill = NULL,
         title = NULL,
         subtitle = "Framlög einstaklinga")

p <- plot_grid(p1, p2, p3, ncol = 1, rel_heights = c(0.95, 0.95, 1))

p

ggsave(plot = p, filename = "image.png",
       width = 8, height = 1 * 8, scale = 1.2, bg = "white")
```

